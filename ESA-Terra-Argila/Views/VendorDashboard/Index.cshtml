@model ESA_Terra_Argila.Models.VendorDashboardViewModel

@{
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
    ViewData["Title"] = "Vendor Dashboard 7d";
}

<h2 class="my-4">Vendor Dashboard</h2>

<!-- Botão para alternar CardView <-> ChartView -->
<div class="d-flex justify-content-end mb-3">
    <button id="toggleViewBtn" class="btn btn-outline-primary">
        <i class="bi bi-graph-up me-1"></i> Ver em gráfico
    </button>
</div>

<!-- Área de Cartões -->
<div id="cardView">
    <div class="row">
        <!-- Exibe @Model.TotalProducts, @Model.TotalSales, etc. -->
        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <h5>Total Produtos</h5>
                <p class="display-6">@Model.TotalProducts</p>
                <a class="btn btn-primary" asp-controller="Products" asp-action="Index">Ver Produtos</a>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <h5>Total Vendas</h5>
                <p class="display-6">@Model.TotalSales</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <h5>Melhor Produto</h5>
                <p><strong>@Model.BestSellingProduct</strong></p>
                <p>Vendidos: @Model.BestSellingQuantity</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <h5>Total Favoritos</h5>
                <p class="display-6">@Model.TotalFavorites</p>
            </div>
        </div>
        <div class="col-md-12 mt-4">
            <div class="card p-3 shadow-sm">
                <h5>Total Faturação</h5>
                <p class="display-6">@Model.TotalRevenue.ToString("C")</p>
            </div>
        </div>
    </div>
</div>


<div id="chartView" style="display: none;">
    
    <div class="chart-container rounded shadow p-4 mb-4 bg-white">
        <h4>Faturação</h4>
        <div id="revenueChart"></div>
    </div>

    
    <div class="chart-container rounded shadow p-4 mb-4 bg-white">
        <h4>Vendas </h4>
        <div id="salesChart"></div>
    </div>

    
    <div class="chart-container rounded shadow p-4 mb-4 bg-white">
        <h4>Produtos</h4>
        <div id="productsChart"></div>
    </div>

    
    <div class="chart-container rounded shadow p-4 bg-white">
        <h4>Produtos Vendidos</h4>
        <div id="departmentSalesChart"></div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <script>
        
        const toggleBtn = document.getElementById("toggleViewBtn");
        const cardView = document.getElementById("cardView");
        const chartView = document.getElementById("chartView");

        toggleBtn.addEventListener("click", () => {
            const showingCards = cardView.style.display !== "none";
            cardView.style.display = showingCards ? "none" : "block";
            chartView.style.display = showingCards ? "block" : "none";
            toggleBtn.innerHTML = showingCards
                ? `<i class="bi bi-grid me-1"></i> Ver em cartões`
                : `<i class="bi bi-graph-up me-1"></i> Ver em gráfico`;
        });

        
        let revenueChart, salesChart, productsChart, monthlySalesChart, departmentSalesChart;

        document.addEventListener("DOMContentLoaded", () => {
            
            revenueChart = new ApexCharts(document.querySelector("#revenueChart"), {
                chart: { type: 'area', height: 300 },
                series: [{ name: 'Faturação', data: [] }],
                xaxis: {
                    
                    categories: ['', '', '', '', '', '', '']
                }
            });
            revenueChart.render();

            
            salesChart = new ApexCharts(document.querySelector("#salesChart"), {
                chart: { type: 'area', height: 300 },
                series: [{ name: 'Vendas', data: [] }],
                xaxis: {
                    categories: ['', '', '', '', '', '', '']
                }
            });
            salesChart.render();

            
            productsChart = new ApexCharts(document.querySelector("#productsChart"), {
                chart: { type: 'area', height: 300 },
                series: [{ name: 'Produtos', data: [] }],
                xaxis: {
                    categories: ['', '', '', '', '', '', '']
                }
            });
            productsChart.render();

            
            monthlySalesChart = new ApexCharts(document.querySelector("#monthlySalesChart"), {
                chart: { type: 'area', height: 300 },
                series: [{ name: 'Monthly Sales', data: [] }],
                xaxis: {
                    categories: ['', '', '', '', '', '', '']
                }
            });
            monthlySalesChart.render();

            
            departmentSalesChart = new ApexCharts(document.querySelector("#departmentSalesChart"), {
                chart: { type: 'donut', height: 300 },
                labels: [],
                series: [],
                legend: { position: 'bottom' }
            });
            departmentSalesChart.render();

            
            fetchAll7d();
        });

        async function fetchAll7d() {
            try {
                
                const [
                    resRevenue,
                    resSales,
                    resProducts,
                    resMonthly,
                    resDept
                ] = await Promise.all([
                    fetch('/VendorDashboard/GetRevenueData7d'),
                    fetch('/VendorDashboard/GetSalesData7d'),
                    fetch('/VendorDashboard/GetProductsData7d'),
                    fetch('/VendorDashboard/GetMonthlySales7d'),
                    fetch('/VendorDashboard/GetDepartmentSales7d')
                ]);

                const dataRevenue = await resRevenue.json();
                const dataSales = await resSales.json();
                const dataProducts = await resProducts.json();
                const dataMonthly = await resMonthly.json();
                const dataDept = await resDept.json();

                
                revenueChart.updateSeries([{ data: dataRevenue }]);

                
                salesChart.updateSeries([{ data: dataSales }]);

                
                productsChart.updateSeries([{ data: dataProducts }]);

                
                monthlySalesChart.updateSeries([{ data: dataMonthly }]);

                
                const deptLabels = dataDept.map(d => d.label);
                const deptTotals = dataDept.map(d => d.total);
                departmentSalesChart.updateOptions({
                    labels: deptLabels
                });
                departmentSalesChart.updateSeries(deptTotals);

            } catch (err) {
                console.error("Erro ao buscar e atualizar graficos 7d vendor:", err);
            }
        }
    </script>
}
